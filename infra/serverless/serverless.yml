service: finance-tracker-api

provider:
  name: aws
  runtime: python3.13
  region: eu-north-1
  profile: Personal
  stage: default
  vpc:
    securityGroupIds:
      - ${ssm:/finance-tracker/${self:provider.stage}/lambda/sg}
    subnetIds:
      - ${ssm:/finance-tracker/${self:provider.stage}/subnet/private-a}
      - ${ssm:/finance-tracker/${self:provider.stage}/subnet/private-b}
  environment:
    DB_ENDPOINT: ${aws:ssm:/finance-tracker/${self:provider.stage}/db/endpoint}
    DB_NAME: ${aws:ssm:/finance-tracker/${self:provider.stage}/db/name}
    DB_USER: ${aws:ssm:/finance-tracker/${self:provider.stage}/db/user}
    DB_PASSWORD: ${aws:ssm:/finance-tracker/${self:provider.stage}/db/password}
    AWS_BEARER_TOKEN_BEDROCK: ${aws:ssm:/finance-tracker/${self:provider.stage}/bedrock/bearer_token}
    IMPORT_FILES_BUCKET: ${aws:ssm:/finance-tracker/${self:provider.stage}/imports/files/bucket}
    IMPORT_FILES_PREFIX: ${aws:ssm:/finance-tracker/${self:provider.stage}/imports/files/prefix}
    IMPORT_FILES_URL_EXPIRES_SECONDS: ${aws:ssm:/finance-tracker/${self:provider.stage}/imports/files/url_expires_seconds}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
          Resource: arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/finance-tracker/${self:provider.stage}/db/*
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
          Resource: arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/finance-tracker/${self:provider.stage}/bedrock/*
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
          Resource: arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/finance-tracker/${self:provider.stage}/imports/files/*
        - Effect: Allow
          Action:
            - bedrock:InvokeModel
          Resource: "*"
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:DeleteItem
            - dynamodb:Query
          Resource:
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${ssm:/finance-tracker/${self:provider.stage}/imports/suggestions/connections_table}
            - arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${ssm:/finance-tracker/${self:provider.stage}/imports/suggestions/connections_table}/index/client_id-index
        - Effect: Allow
          Action:
            - sqs:SendMessage
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
          Resource:
            - ${ssm:/finance-tracker/${self:provider.stage}/imports/suggestions/queue_arn}
        - Effect: Allow
          Action:
            - execute-api:ManageConnections
          Resource:
            - Fn::Sub: "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebsocketsApi}/*"
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:AbortMultipartUpload
            - s3:ListBucket
          Resource:
            - arn:aws:s3:::${ssm:/finance-tracker/${self:provider.stage}/backups/bucket}
            - arn:aws:s3:::${ssm:/finance-tracker/${self:provider.stage}/backups/bucket}/*
            - arn:aws:s3:::${aws:ssm:/finance-tracker/${self:provider.stage}/imports/files/bucket}/*
            - arn:aws:s3:::${aws:ssm:/finance-tracker/${self:provider.stage}/imports/files/bucket}
  httpApi:
    name: ${self:service}-${self:provider.stage}-http
    cors: true
    authorizers:
      cognitoJwt:
        type: jwt
        identitySource: "$request.header.Authorization"
        issuerUrl: ${aws:ssm:/finance-tracker/${self:provider.stage}/auth/user_pool_issuer}
        audience:
          - ${aws:ssm:/finance-tracker/${self:provider.stage}/auth/user_pool_client_id}
  websocketsApiName: ${self:service}-${self:provider.stage}-ws
  websocketsApiRouteSelectionExpression: $request.body.action

package:
  patterns:
    - ../../apps/api/**
    - "!../../apps/api/**/__pycache__/**"
    - "!../../apps/api/**/*.pyc"
    - "!node_modules/**"
    - "!package-lock.json"
    - "!venv/**"

custom:
  backendLayerArn: ${cf:finance-tracker-layer-service-${self:provider.stage}.BackendDepsLambdaLayerQualifiedArn}

functions:
  databaseBackup:
    handler: apps/api/handlers/backups.run_database_backup
    timeout: 900
    memorySize: 1024
    layers:
      - ${self:custom.backendLayerArn}
    environment:
      BACKUP_BUCKET_NAME: ${ssm:/finance-tracker/${self:provider.stage}/backups/bucket}
      BACKUP_PREFIX: finance-tracker/${self:provider.stage}/database-backups
    events:
      - schedule:
          rate: cron(0 3 1 * ? *)
          enabled: true
          description: Monthly export of database tables to S3

  runTransactionsBackup:
    handler: apps/api/handlers/backups.run_transactions_backup
    timeout: 29
    memorySize: 1024
    layers:
      - ${self:custom.backendLayerArn}
    environment:
      BACKUP_BUCKET_NAME: ${ssm:/finance-tracker/${self:provider.stage}/backups/bucket}
      BACKUP_PREFIX: finance-tracker/${self:provider.stage}/database-backups
    events:
      - httpApi:
          path: /backups/transactions
          method: POST
          authorizer: cognitoJwt

  warmDatabase:
    handler: apps/api/handlers/warmup.warm_database
    timeout: 29
    memorySize: 256
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /warmup
          method: GET
          authorizer: cognitoJwt

  listAccounts:
    handler: apps/api/handlers/accounts.list_accounts
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /accounts
          method: GET
          authorizer: cognitoJwt

  createAccount:
    handler: apps/api/handlers/accounts.create_account
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /accounts
          method: POST
          authorizer: cognitoJwt

  updateAccount:
    handler: apps/api/handlers/accounts.update_account
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /accounts/{accountId}
          method: PATCH
          authorizer: cognitoJwt

  reconcileAccount:
    handler: apps/api/handlers/accounts.reconcile_account
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /accounts/{accountId}/reconcile
          method: POST
          authorizer: cognitoJwt

  previewImports:
    handler: apps/api/handlers/imports.preview_imports
    memorySize: 512
    timeout: 29
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /imports/preview
          method: POST
          authorizer: cognitoJwt

  commitImports:
    handler: apps/api/handlers/imports.commit_imports
    memorySize: 512
    timeout: 29
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /imports/commit
          method: POST
          authorizer: cognitoJwt

  listImportFiles:
    handler: apps/api/handlers/import_files.list_import_files
    memorySize: 512
    timeout: 29
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /import-files
          method: GET
          authorizer: cognitoJwt

  downloadImportFile:
    handler: apps/api/handlers/import_files.download_import_file
    memorySize: 512
    timeout: 29
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /import-files/download
          method: POST
          authorizer: cognitoJwt

  suggestImportCategories:
    handler: apps/api/handlers/bedrock_suggestions.suggest_import_categories
    timeout: 29
    memorySize: 512
    vpc: ~
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /imports/suggest-categories
          method: POST
          authorizer: cognitoJwt

  importSuggestionsConnect:
    handler: apps/api/handlers/bedrock_suggestions.connect_import_suggestions
    timeout: 10
    memorySize: 256
    vpc: ~
    layers:
      - ${self:custom.backendLayerArn}
    environment:
      IMPORT_SUGGESTIONS_CONNECTIONS_TABLE: ${ssm:/finance-tracker/${self:provider.stage}/imports/suggestions/connections_table}
    events:
      - websocket:
          route: $connect

  importSuggestionsDisconnect:
    handler: apps/api/handlers/bedrock_suggestions.disconnect_import_suggestions
    timeout: 10
    memorySize: 256
    vpc: ~
    layers:
      - ${self:custom.backendLayerArn}
    environment:
      IMPORT_SUGGESTIONS_CONNECTIONS_TABLE: ${ssm:/finance-tracker/${self:provider.stage}/imports/suggestions/connections_table}
    events:
      - websocket:
          route: $disconnect

  suggestImportCategoriesJob:
    handler: apps/api/handlers/bedrock_suggestions.enqueue_import_category_suggestions
    timeout: 15
    memorySize: 256
    vpc: ~
    layers:
      - ${self:custom.backendLayerArn}
    environment:
      IMPORT_SUGGESTIONS_CONNECTIONS_TABLE: ${ssm:/finance-tracker/${self:provider.stage}/imports/suggestions/connections_table}
      IMPORT_SUGGESTIONS_QUEUE_URL: ${ssm:/finance-tracker/${self:provider.stage}/imports/suggestions/queue_url}
    events:
      - httpApi:
          path: /imports/suggest-categories/jobs
          method: POST
          authorizer: cognitoJwt

  importSuggestionsWorker:
    handler: apps/api/handlers/bedrock_suggestions.process_import_category_suggestions
    timeout: 120
    memorySize: 512
    vpc: ~
    layers:
      - ${self:custom.backendLayerArn}
    environment:
      IMPORT_SUGGESTIONS_CONNECTIONS_TABLE: ${ssm:/finance-tracker/${self:provider.stage}/imports/suggestions/connections_table}
      IMPORT_SUGGESTIONS_QUEUE_URL: ${ssm:/finance-tracker/${self:provider.stage}/imports/suggestions/queue_url}
    events:
      - sqs:
          arn: ${ssm:/finance-tracker/${self:provider.stage}/imports/suggestions/queue_arn}
          batchSize: 1

  getSettings:
    handler: apps/api/handlers/settings.get_settings
    timeout: 10
    memorySize: 256
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /settings
          method: GET
          authorizer: cognitoJwt

  saveSettings:
    handler: apps/api/handlers/settings.save_settings
    timeout: 10
    memorySize: 256
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /settings
          method: PUT
          authorizer: cognitoJwt

  listCategories:
    handler: apps/api/handlers/categories.list_categories
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /categories
          method: GET
          authorizer: cognitoJwt

  createCategory:
    handler: apps/api/handlers/categories.create_category
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /categories
          method: POST
          authorizer: cognitoJwt

  updateCategory:
    handler: apps/api/handlers/categories.update_category
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /categories/{categoryId}
          method: PATCH
          authorizer: cognitoJwt

  mergeCategories:
    handler: apps/api/handlers/categories.merge_categories
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /categories/merge
          method: POST
          authorizer: cognitoJwt

  listBudgets:
    handler: apps/api/handlers/budgets.list_budgets
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /budgets
          method: GET
          authorizer: cognitoJwt

  createBudget:
    handler: apps/api/handlers/budgets.create_budget
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /budgets
          method: POST
          authorizer: cognitoJwt

  updateBudget:
    handler: apps/api/handlers/budgets.update_budget
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /budgets/{budgetId}
          method: PATCH
          authorizer: cognitoJwt

  deleteBudget:
    handler: apps/api/handlers/budgets.delete_budget
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /budgets/{budgetId}
          method: DELETE
          authorizer: cognitoJwt

  listBudgetProgress:
    handler: apps/api/handlers/budgets.list_budget_progress
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /budgets/progress
          method: GET
          authorizer: cognitoJwt

  listGoals:
    handler: apps/api/handlers/goals.list_goals
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /goals
          method: GET
          authorizer: cognitoJwt

  createGoal:
    handler: apps/api/handlers/goals.create_goal
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /goals
          method: POST
          authorizer: cognitoJwt

  updateGoal:
    handler: apps/api/handlers/goals.update_goal
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /goals/{goalId}
          method: PATCH
          authorizer: cognitoJwt

  deleteGoal:
    handler: apps/api/handlers/goals.delete_goal
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /goals/{goalId}
          method: DELETE
          authorizer: cognitoJwt

  listTransactions:
    handler: apps/api/handlers/transactions.list_transactions
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /transactions
          method: GET
          authorizer: cognitoJwt

  createTransaction:
    handler: apps/api/handlers/transactions.create_transaction
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /transactions
          method: POST
          authorizer: cognitoJwt

  listTaxEvents:
    handler: apps/api/handlers/tax.list_tax_events
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /tax/events
          method: GET
          authorizer: cognitoJwt

  createTaxEvent:
    handler: apps/api/handlers/tax.create_tax_event
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /tax/events
          method: POST
          authorizer: cognitoJwt

  taxSummary:
    handler: apps/api/handlers/tax.tax_summary
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /tax/summary
          method: GET
          authorizer: cognitoJwt

  taxTotalSummary:
    handler: apps/api/handlers/tax.tax_total_summary
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /tax/summary/total
          method: GET
          authorizer: cognitoJwt

  listSubscriptions:
    handler: apps/api/handlers/subscriptions.list_subscriptions
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /subscriptions
          method: GET
          authorizer: cognitoJwt

  createSubscription:
    handler: apps/api/handlers/subscriptions.create_subscription
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /subscriptions
          method: POST
          authorizer: cognitoJwt

  updateSubscription:
    handler: apps/api/handlers/subscriptions.update_subscription
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /subscriptions/{subscriptionId}
          method: PATCH
          authorizer: cognitoJwt

  attachSubscription:
    handler: apps/api/handlers/subscriptions.attach_subscription
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /transactions/{transactionId}/subscription
          method: PUT
          authorizer: cognitoJwt

  detachSubscription:
    handler: apps/api/handlers/subscriptions.detach_subscription
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /transactions/{transactionId}/subscription
          method: DELETE
          authorizer: cognitoJwt

  listSubscriptionSummaries:
    handler: apps/api/handlers/subscriptions.list_subscription_summaries
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /subscriptions/summary
          method: GET
          authorizer: cognitoJwt

  createLoan:
    handler: apps/api/handlers/loans.create_loan
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /loans
          method: POST
          authorizer: cognitoJwt

  updateLoan:
    handler: apps/api/handlers/loans.update_loan
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /loans/{accountId}
          method: PATCH
          authorizer: cognitoJwt

  listLoanEvents:
    handler: apps/api/handlers/loans.list_loan_events
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /loans/{accountId}/events
          method: GET
          authorizer: cognitoJwt

  listLoanPortfolioSeries:
    handler: apps/api/handlers/loans.list_loan_portfolio_series
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /loans/events/series
          method: GET
          authorizer: cognitoJwt

  getLoanSchedule:
    handler: apps/api/handlers/loans.get_loan_schedule
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /loans/{accountId}/schedule
          method: GET
          authorizer: cognitoJwt

  monthlyReport:
    handler: apps/api/handlers/reporting.monthly_report
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/monthly
          method: GET
          authorizer: cognitoJwt

  yearlyReport:
    handler: apps/api/handlers/reporting.yearly_report
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/yearly
          method: GET
          authorizer: cognitoJwt

  yearlyOverview:
    handler: apps/api/handlers/reporting.yearly_overview
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/yearly-overview
          method: GET
          authorizer: cognitoJwt

  yearlyCategoryDetail:
    handler: apps/api/handlers/reporting.yearly_category_detail
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/yearly-category-detail
          method: GET
          authorizer: cognitoJwt

  quarterlyReport:
    handler: apps/api/handlers/reporting.quarterly_report
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/quarterly
          method: GET
          authorizer: cognitoJwt

  dateRangeReport:
    handler: apps/api/handlers/reporting.date_range_report
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/custom
          method: GET
          authorizer: cognitoJwt

  totalReport:
    handler: apps/api/handlers/reporting.total_report
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/total
          method: GET
          authorizer: cognitoJwt

  totalOverview:
    handler: apps/api/handlers/reporting.total_overview
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/total-overview
          method: GET
          authorizer: cognitoJwt

  netWorthHistory:
    handler: apps/api/handlers/reporting.net_worth_history
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/net-worth
          method: GET
          authorizer: cognitoJwt

  cashflowForecast:
    handler: apps/api/handlers/reporting.cashflow_forecast
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/forecast/cashflow
          method: GET
          authorizer: cognitoJwt

  netWorthProjection:
    handler: apps/api/handlers/reporting.net_worth_projection
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/forecast/net-worth
          method: GET
          authorizer: cognitoJwt

  exportReport:
    handler: apps/api/handlers/reporting.export_report
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/export
          method: POST
          authorizer: cognitoJwt

  listInvestmentTransactions:
    handler: apps/api/handlers/investments.list_investment_transactions
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /investments/transactions
          method: GET
          authorizer: cognitoJwt

  investmentOverview:
    handler: apps/api/handlers/investments.investment_overview
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /investments/overview
          method: GET
          authorizer: cognitoJwt
