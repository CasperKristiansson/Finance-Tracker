service: finance-tracker-api

provider:
  name: aws
  runtime: python3.13
  region: eu-north-1
  profile: Personal
  stage: default
  vpc:
    securityGroupIds:
      - ${ssm:/finance-tracker/${self:provider.stage}/lambda/sg}
    subnetIds:
      - ${ssm:/finance-tracker/${self:provider.stage}/subnet/private-a}
      - ${ssm:/finance-tracker/${self:provider.stage}/subnet/private-b}
  environment:
    DB_ENDPOINT: ${aws:ssm:/finance-tracker/${self:provider.stage}/db/endpoint}
    DB_NAME: ${aws:ssm:/finance-tracker/${self:provider.stage}/db/name}
    DB_USER: ${aws:ssm:/finance-tracker/${self:provider.stage}/db/user}
    DB_PASSWORD: ${aws:ssm:/finance-tracker/${self:provider.stage}/db/password}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
          Resource: arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/finance-tracker/${self:provider.stage}/db/*
  domain:
    name: api.finance-tracker.casperkristiansson.com
    apiType: httpApi
    endpointType: regional
    certificateArn: ${aws:ssm:/finance-tracker/${self:provider.stage}/api/custom_domain/certificate_arn}
    createRoute53Record: true
    createRoute53IPv6Record: true
  httpApi:
    cors: true
    authorizers:
      cognitoJwt:
        type: jwt
        identitySource: "$request.header.Authorization"
        issuerUrl: ${aws:ssm:/finance-tracker/${self:provider.stage}/auth/user_pool_issuer}
        audience:
          - ${aws:ssm:/finance-tracker/${self:provider.stage}/auth/user_pool_client_id}

custom:
  backendLayerArn: ${cf:finance-tracker-layer-service-${self:provider.stage}.BackendDepsLambdaLayerQualifiedArn}

functions:
  listAccounts:
    handler: apps/api/handlers/accounts.list_accounts
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /accounts
          method: GET
          authorizer: cognitoJwt

  createAccount:
    handler: apps/api/handlers/accounts.create_account
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /accounts
          method: POST
          authorizer: cognitoJwt

  updateAccount:
    handler: apps/api/handlers/accounts.update_account
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /accounts/{accountId}
          method: PATCH
          authorizer: cognitoJwt

  listCategories:
    handler: apps/api/handlers/categories.list_categories
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /categories
          method: GET
          authorizer: cognitoJwt

  createCategory:
    handler: apps/api/handlers/categories.create_category
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /categories
          method: POST
          authorizer: cognitoJwt

  updateCategory:
    handler: apps/api/handlers/categories.update_category
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /categories/{categoryId}
          method: PATCH
          authorizer: cognitoJwt

  listTransactions:
    handler: apps/api/handlers/transactions.list_transactions
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /transactions
          method: GET
          authorizer: cognitoJwt

  createTransaction:
    handler: apps/api/handlers/transactions.create_transaction
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /transactions
          method: POST
          authorizer: cognitoJwt

  createLoan:
    handler: apps/api/handlers/loans.create_loan
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /loans
          method: POST
          authorizer: cognitoJwt

  updateLoan:
    handler: apps/api/handlers/loans.update_loan
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /loans/{accountId}
          method: PATCH
          authorizer: cognitoJwt

  listLoanEvents:
    handler: apps/api/handlers/loans.list_loan_events
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /loans/{accountId}/events
          method: GET
          authorizer: cognitoJwt

  getLoanSchedule:
    handler: apps/api/handlers/loans.get_loan_schedule
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /loans/{accountId}/schedule
          method: GET
          authorizer: cognitoJwt

  monthlyReport:
    handler: apps/api/handlers/reporting.monthly_report
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/monthly
          method: GET
          authorizer: cognitoJwt

  yearlyReport:
    handler: apps/api/handlers/reporting.yearly_report
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/yearly
          method: GET
          authorizer: cognitoJwt

  totalReport:
    handler: apps/api/handlers/reporting.total_report
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/total
          method: GET
          authorizer: cognitoJwt
