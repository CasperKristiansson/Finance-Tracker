service: finance-tracker-api

provider:
  name: aws
  runtime: python3.13
  region: eu-north-1
  profile: Personal
  stage: default
  vpc:
    securityGroupIds:
      - ${ssm:/finance-tracker/${self:provider.stage}/lambda/sg}
    subnetIds:
      - ${ssm:/finance-tracker/${self:provider.stage}/subnet/private-a}
      - ${ssm:/finance-tracker/${self:provider.stage}/subnet/private-b}
  environment:
    DB_ENDPOINT: ${aws:ssm:/finance-tracker/${self:provider.stage}/db/endpoint}
    DB_NAME: ${aws:ssm:/finance-tracker/${self:provider.stage}/db/name}
    DB_USER: ${aws:ssm:/finance-tracker/${self:provider.stage}/db/user}
    DB_PASSWORD: ${aws:ssm:/finance-tracker/${self:provider.stage}/db/password}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
          Resource: arn:aws:ssm:${aws:region}:${aws:accountId}:parameter/finance-tracker/${self:provider.stage}/db/*
  domain:
    name: api.finance-tracker.casperkristiansson.com
    apiType: HTTP
    endpointType: regional
    certificateArn: ${aws:ssm:/finance-tracker/${self:provider.stage}/api/custom_domain/certificate_arn}
    createRoute53Record: true
    createRoute53IPv6Record: true
  httpApi:
    cors: true
    authorizers:
      cognitoJwt:
        type: jwt
        identitySource: "$request.header.Authorization"
        issuerUrl: ${aws:ssm:/finance-tracker/${self:provider.stage}/auth/user_pool_issuer}
        audience:
          - ${aws:ssm:/finance-tracker/${self:provider.stage}/auth/user_pool_client_id}

custom:
  backendLayerArn: ${cf:finance-tracker-layer-service-${self:provider.stage}.BackendDepsLambdaLayerQualifiedArn}

functions:
  warmDatabase:
    handler: apps/api/handlers/warmup.warm_database
    timeout: 12
    memorySize: 256
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /warmup
          method: GET
          authorizer: none

  listAccounts:
    handler: apps/api/handlers/accounts.list_accounts
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /accounts
          method: GET
          authorizer: cognitoJwt

  createAccount:
    handler: apps/api/handlers/accounts.create_account
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /accounts
          method: POST
          authorizer: cognitoJwt

  updateAccount:
    handler: apps/api/handlers/accounts.update_account
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /accounts/{accountId}
          method: PATCH
          authorizer: cognitoJwt

  reconcileAccount:
    handler: apps/api/handlers/accounts.reconcile_account
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /accounts/{accountId}/reconcile
          method: POST
          authorizer: cognitoJwt

  listImports:
    handler: apps/api/handlers/imports.list_import_batches
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /imports
          method: GET
          authorizer: cognitoJwt

  createImportBatch:
    handler: apps/api/handlers/imports.create_import_batch
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /imports
          method: POST
          authorizer: cognitoJwt

  getImportSession:
    handler: apps/api/handlers/imports.get_import_session
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /imports/{batch_id}
          method: GET
          authorizer: cognitoJwt

  appendImportFiles:
    handler: apps/api/handlers/imports.append_import_files
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /imports/{batch_id}/files
          method: POST
          authorizer: cognitoJwt

  commitImportSession:
    handler: apps/api/handlers/imports.commit_import_session
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /imports/{batch_id}/commit
          method: POST
          authorizer: cognitoJwt

  listCategories:
    handler: apps/api/handlers/categories.list_categories
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /categories
          method: GET
          authorizer: cognitoJwt

  createCategory:
    handler: apps/api/handlers/categories.create_category
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /categories
          method: POST
          authorizer: cognitoJwt

  updateCategory:
    handler: apps/api/handlers/categories.update_category
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /categories/{categoryId}
          method: PATCH
          authorizer: cognitoJwt

  mergeCategories:
    handler: apps/api/handlers/categories.merge_categories
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /categories/merge
          method: POST
          authorizer: cognitoJwt

  listBudgets:
    handler: apps/api/handlers/budgets.list_budgets
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /budgets
          method: GET
          authorizer: cognitoJwt

  createBudget:
    handler: apps/api/handlers/budgets.create_budget
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /budgets
          method: POST
          authorizer: cognitoJwt

  updateBudget:
    handler: apps/api/handlers/budgets.update_budget
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /budgets/{budgetId}
          method: PATCH
          authorizer: cognitoJwt

  deleteBudget:
    handler: apps/api/handlers/budgets.delete_budget
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /budgets/{budgetId}
          method: DELETE
          authorizer: cognitoJwt

  listBudgetProgress:
    handler: apps/api/handlers/budgets.list_budget_progress
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /budgets/progress
          method: GET
          authorizer: cognitoJwt

  listGoals:
    handler: apps/api/handlers/goals.list_goals
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /goals
          method: GET
          authorizer: cognitoJwt

  createGoal:
    handler: apps/api/handlers/goals.create_goal
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /goals
          method: POST
          authorizer: cognitoJwt

  updateGoal:
    handler: apps/api/handlers/goals.update_goal
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /goals/{goalId}
          method: PATCH
          authorizer: cognitoJwt

  deleteGoal:
    handler: apps/api/handlers/goals.delete_goal
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /goals/{goalId}
          method: DELETE
          authorizer: cognitoJwt

  listTransactions:
    handler: apps/api/handlers/transactions.list_transactions
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /transactions
          method: GET
          authorizer: cognitoJwt

  createTransaction:
    handler: apps/api/handlers/transactions.create_transaction
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /transactions
          method: POST
          authorizer: cognitoJwt

  listSubscriptions:
    handler: apps/api/handlers/subscriptions.list_subscriptions
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /subscriptions
          method: GET
          authorizer: cognitoJwt

  createSubscription:
    handler: apps/api/handlers/subscriptions.create_subscription
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /subscriptions
          method: POST
          authorizer: cognitoJwt

  updateSubscription:
    handler: apps/api/handlers/subscriptions.update_subscription
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /subscriptions/{subscriptionId}
          method: PATCH
          authorizer: cognitoJwt

  attachSubscription:
    handler: apps/api/handlers/subscriptions.attach_subscription
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /transactions/{transactionId}/subscription
          method: PUT
          authorizer: cognitoJwt

  detachSubscription:
    handler: apps/api/handlers/subscriptions.detach_subscription
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /transactions/{transactionId}/subscription
          method: DELETE
          authorizer: cognitoJwt

  listSubscriptionSummaries:
    handler: apps/api/handlers/subscriptions.list_subscription_summaries
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /subscriptions/summary
          method: GET
          authorizer: cognitoJwt

  createLoan:
    handler: apps/api/handlers/loans.create_loan
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /loans
          method: POST
          authorizer: cognitoJwt

  updateLoan:
    handler: apps/api/handlers/loans.update_loan
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /loans/{accountId}
          method: PATCH
          authorizer: cognitoJwt

  listLoanEvents:
    handler: apps/api/handlers/loans.list_loan_events
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /loans/{accountId}/events
          method: GET
          authorizer: cognitoJwt

  getLoanSchedule:
    handler: apps/api/handlers/loans.get_loan_schedule
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /loans/{accountId}/schedule
          method: GET
          authorizer: cognitoJwt

  monthlyReport:
    handler: apps/api/handlers/reporting.monthly_report
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/monthly
          method: GET
          authorizer: cognitoJwt

  yearlyReport:
    handler: apps/api/handlers/reporting.yearly_report
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/yearly
          method: GET
          authorizer: cognitoJwt

  quarterlyReport:
    handler: apps/api/handlers/reporting.quarterly_report
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/quarterly
          method: GET
          authorizer: cognitoJwt

  dateRangeReport:
    handler: apps/api/handlers/reporting.date_range_report
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/custom
          method: GET
          authorizer: cognitoJwt

  totalReport:
    handler: apps/api/handlers/reporting.total_report
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/total
          method: GET
          authorizer: cognitoJwt

  netWorthHistory:
    handler: apps/api/handlers/reporting.net_worth_history
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/net-worth
          method: GET
          authorizer: cognitoJwt

  cashflowForecast:
    handler: apps/api/handlers/reporting.cashflow_forecast
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/forecast/cashflow
          method: GET
          authorizer: cognitoJwt

  netWorthProjection:
    handler: apps/api/handlers/reporting.net_worth_projection
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/forecast/net-worth
          method: GET
          authorizer: cognitoJwt

  exportReport:
    handler: apps/api/handlers/reporting.export_report
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /reports/export
          method: POST
          authorizer: cognitoJwt

  createNordnetSnapshot:
    handler: apps/api/handlers/investments.create_nordnet_snapshot
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /investments/nordnet/snapshots
          method: POST
          authorizer: cognitoJwt

  listNordnetSnapshots:
    handler: apps/api/handlers/investments.list_nordnet_snapshots
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /investments/nordnet/snapshots
          method: GET
          authorizer: cognitoJwt

  parseNordnetExport:
    handler: apps/api/handlers/investments.parse_nordnet_export
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /investments/nordnet/parse
          method: POST
          authorizer: cognitoJwt

  listInvestmentTransactions:
    handler: apps/api/handlers/investments.list_investment_transactions
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /investments/transactions
          method: GET
          authorizer: cognitoJwt

  investmentMetrics:
    handler: apps/api/handlers/investments.investment_metrics
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /investments/metrics
          method: GET
          authorizer: cognitoJwt

  syncInvestmentLedger:
    handler: apps/api/handlers/investments.sync_investment_ledger
    timeout: 29
    memorySize: 512
    layers:
      - ${self:custom.backendLayerArn}
    events:
      - httpApi:
          path: /investments/sync-ledger
          method: POST
          authorizer: cognitoJwt
